<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Skyblock XP Calculator</title>
    <link rel="icon" type="image/png" href="site-icon.png" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body style="background-image: url('bgimage.jpeg'); background-size: cover; background-position: center;">
    <div class="container">
      <div class="darken">
        <nav class="nav-bar">
          <a href="index.html">Orders</a>
          <a href="saved-orders.html">Saved Orders</a>
          <a class="active" href="sb-xp-calculator.html">Skyblock Xp Calculator</a>
          <span id="authLinks" class="auth-links"></span>
        </nav>

        <h1>Skyblock XP Calculator</h1>
        <div class="subheading" style="text-align: left;">
          Here you can view a list of the most efficient ways to spend coins on Skyblock xp.<br>
          For most efficient minion crafts, visit <a href="https://hyminions.herokuapp.com/minionscost" target="_blank">hyminions.herokuapp.com/minionscost</a>.
        </div>

        <div class="xp-methods" id="xpMethodsContainer"></div>
      </div>
    </div>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

      const SUPABASE_URL = "https://dhgfmbsyndfbsretlhvm.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRoZ2ZtYnN5bmRmYnNyZXRsaHZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ3MzA2MDUsImV4cCI6MjA2MDMwNjYwNX0.Xy6a2BMXaEOBQV2vJrKWbivaP4tYE6nAQ8tSQG-wTZI";
      const API_KEY = "6d4b47ff-1672-48b9-a1e5-78a97f03883d";
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const authLinks = document.getElementById("authLinks");
      let currentUser;

      async function checkAuth() {
        const { data: { user } } = await supabase.auth.getUser();
        currentUser = user;
        if (user) {
          authLinks.innerHTML = `Logged in as <strong>${user.user_metadata.username}</strong> <a href="#" onclick="logout()">Log Out</a>`;
          loadXPMethods(user.id);
        } else {
          authLinks.innerHTML = `<a href="auth.html">Sign In / Sign Up</a>`;
        }
      }

      async function logout() {
        await supabase.auth.signOut();
        location.reload();
      }

      async function loadXPMethods(uid) {
        const xpContainer = document.getElementById("xpMethodsContainer");
        xpContainer.innerHTML = "Loading...";

        const profileRes = await supabase.from("users").select("sb_profile, ign").eq("id", uid).single();
        if (!profileRes.data) {
          xpContainer.innerHTML = "Profile not found. Please set it in your account.";
          return;
        }

        const { ign, sb_profile } = profileRes.data;
        const profileApiUrl = `https://api.hypixel.net/skyblock/profiles?key=${API_KEY}&uuid=${ign}`;
        const profileData = await fetch(profileApiUrl).then(res => res.json());

        const playerProfile = profileData.profiles.find(p => p.cute_name === sb_profile);
        if (!playerProfile) {
          xpContainer.innerHTML = "Skyblock profile not found.";
          return;
        }

        const museum = playerProfile.members[ign].museum ?? {};
        const collections = playerProfile.members[ign].collection ?? {};

        const raw = await fetch("xpMethods.json").then(r => r.json());

        const filtered = raw.filter(method => {
          const req = method.requirements || {};
          if (req.profile?.museum && museum.milestone < req.profile.museum) return false;
          if (req.collection) {
            const colAmt = collections[req.collection.name.toUpperCase()] || 0;
            if (colAmt < req.collection.amount) return false;
          }
          return true;
        });

        xpContainer.innerHTML = "";
        for (const method of filtered) {
          const div = document.createElement("div");
          div.className = "xp-card";
          div.innerHTML = `
            <h2>${method.name}</h2>
            <p>${method.description}</p>
            <p><strong>XP:</strong> ${method.xp} | <strong>Coins:</strong> ${method.coins.toLocaleString()}</p>
            ${method.sources?.map(s => `<p><strong>From:</strong> ${s.type.toUpperCase()} - ${s.id} Ã— ${s.amount}</p>`).join('') || ""}
          `;
          xpContainer.appendChild(div);
        }
      }

      checkAuth();
    </script>
  </body>
</html>
