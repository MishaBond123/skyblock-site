<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" href="site-icon.png" />
  <title>Skyblock XP Calculator</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- NAVIGATION -->
  <div class="nav">
    <a href="index.html" class="navbtn">Orders</a>
    <a href="saved-orders.html" class="navbtn">Saved Orders</a>
    <a href="sb-xp-calculator.html" class="navbtn active">Skyblock Xp Calculator</a>
    <span id="authStatus" class="nav-right"></span>
  </div>

  <!-- CONTENT -->
  <div class="container">
    <h1 class="header">Skyblock XP Calculator</h1>
    <p class="subheading" style="text-align: left;">
      Here you can view a list of the most efficient ways to spend coins on Skyblock xp.<br>
      For most efficient minion crafts, visit 
      <a href="https://hyminions.herokuapp.com/minionscost" target="_blank">hyminions.herokuapp.com/minionscost</a>.
    </p>

    <div class="xp-methods" id="xpMethodsContainer"></div>
  </div>

  <!-- SUPABASE + LOGIC -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const SUPABASE_URL = "https://dhgfmbsyndfbsretlhvm.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRoZ2ZtYnN5bmRmYnNyZXRsaHZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ3MzA2MDUsImV4cCI6MjA2MDMwNjYwNX0.Xy6a2BMXaEOBQV2vJrKWbivaP4tYE6nAQ8tSQG-wTZI";
    const API_KEY = "6d4b47ff-1672-48b9-a1e5-78a97f03883d";

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const authStatus = document.getElementById("authStatus");
    const container = document.getElementById("xpMethodsContainer");

    const username = sessionStorage.getItem("username");
    const userId = sessionStorage.getItem("user_id");
    const mcUsername = sessionStorage.getItem("mc_username");
    const sbProfile = sessionStorage.getItem("sb_profile");

    // Setup navbar login state
    if (username && userId) {
      authStatus.innerHTML = `
        Logged in as <strong>${username}</strong>
        <a href="#" id="logoutLink" style="color:#00bfff; margin-left:10px;">Log Out</a>
      `;
      document.getElementById("logoutLink").onclick = () => {
        sessionStorage.clear();
        location.reload();
      };
    } else {
      authStatus.innerHTML = `<a href="auth.html" class="link">Log In / Sign Up</a>`;
    }

    async function fetchUUID(username) {
      const res = await fetch(`https://api.mojang.com/users/profiles/minecraft/${username}`);
      const json = await res.json();
      return json.id;
    }

    async function fetchProfile(uuid) {
      const res = await fetch(`https://api.hypixel.net/skyblock/profiles?key=${API_KEY}&uuid=${uuid}`);
      const data = await res.json();
      return data.profiles.find(p => p.cute_name.toLowerCase() === sbProfile.toLowerCase());
    }

    async function fetchXpMethods() {
      const res = await fetch("xpMethods.json");
      return await res.json();
    }

    function meetsRequirements(method, profileData) {
      const req = method.requirements || {};
      if (req.profile?.requires_api && !profileData) return false;

      if (req.profile?.museumMilestone !== undefined) {
        if ((profileData?.museum || 0) < req.profile.museumMilestone) return false;
      }

      if (req.collection) {
        const key = req.collection.name.toUpperCase();
        const currentAmount = profileData?.collections?.[key] || 0;
        if (currentAmount < req.collection.amount) return false;
      }

      return true;
    }

    async function init() {
      if (!username || !userId || !mcUsername || !sbProfile) {
        container.innerHTML = `<p style="font-size: 16px; color: #eee;">You must <a href="auth.html" class="link">log in</a> to view personalized XP recommendations.</p>`;
        return;
      }

      try {
        const uuid = await fetchUUID(mcUsername);
        const profile = await fetchProfile(uuid);
        const member = profile.members[uuid];

        const profileData = {
          museum: member.museum?.milestone || 0,
          collections: member.collection || {}
        };

        const methods = await fetchXpMethods();
        const valid = methods.filter(method => meetsRequirements(method, profileData));

        if (valid.length === 0) {
          container.innerHTML = `<p style="font-size: 16px; color: #eee;">No XP methods match your profile.</p>`;
          return;
        }

        for (const method of valid) {
          const div = document.createElement("div");
          div.className = "order-row";
          div.innerHTML = `
            <div><strong>${method.name}</strong></div>
            <div style="font-size: 14px;">${method.description}</div>
            <div style="font-size: 14px; margin-top: 4px;">+${method.xp} XP â€” ${method.coins?.toLocaleString() || "?"} coins</div>
          `;
          container.appendChild(div);
        }
      } catch (err) {
        container.innerHTML = `<p style="font-size: 16px; color: #eee;">Failed to fetch profile or XP data.</p>`;
        console.error(err);
      }
    }

    init();
  </script>
</body>
</html>
