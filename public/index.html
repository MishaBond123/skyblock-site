<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Bazaar Orders (WATO)</title>
<link rel="icon" href="site-icon.png"/>
<style>
  :root{--card:rgba(0,0,0,.68);--head:rgba(0,191,255,.28);--text:#f5f7fa;--muted:rgba(255,255,255,.75);--border:rgba(255,255,255,.12)}
  *{box-sizing:border-box}
  body{margin:0;color:var(--text);font-family:system-ui,Segoe UI,Roboto,sans-serif;background:url('bgimage.jpeg') center/cover fixed no-repeat}
  .container{max-width:1200px;margin:28px auto;padding:0 16px}
  h1{margin:0 0 16px}
  .panel{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:16px;backdrop-filter:saturate(120%) blur(2px)}
  label{display:block;margin:0 0 6px}
  input[type="text"]{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);outline:none;font-size:15px}
  .muted{color:var(--muted);font-size:14px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:960px){.grid{grid-template-columns:1fr}}
  table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
  thead th{background:var(--head);padding:10px;text-align:center;border-bottom:1px solid var(--border)}
  tbody td{padding:10px;text-align:center;border-bottom:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.03)}
  tr:nth-child(even) td{background:rgba(255,255,255,.045)}
  tfoot td{padding:10px;font-weight:700;background:rgba(255,255,255,.06)}
  .dropdown{position:relative}
  .dropdown-menu{position:absolute;left:0;right:0;z-index:10;margin-top:6px;max-height:300px;overflow:auto;background:var(--card);border:1px solid var(--border);border-radius:10px;display:none}
  .dropdown-item{padding:8px 10px;cursor:pointer}
  .dropdown-item:hover{background:rgba(255,255,255,.06)}
  .row{display:flex;gap:12px;align-items:center;margin-top:8px}
</style>
</head>
<body>
  <div class="container">
    <h1>Bazaar Orders</h1>

    <div class="panel">
      <p style="margin-bottom: 1em; color: #ccc; max-width: 600px;">
        <b>This website is a demonstration of the WATO API, created by 7xy_.</b>
        Orders beyond priority 30 (in both buy and sell) are estimated based on their presence within the past 7 days.
        This means they could have been cancelled, so they should be treated as assumptions rather than confirmed data.
        That said, these estimates are fairly reliable - around 65% of estimated orders are still active.
      </p>
      <div class="dropdown">
        <label for="itemInput">Item ID</label>
        <input id="itemInput" type="text" autocomplete="off" placeholder="Type an Item ID, then press Enter"/>
        <div id="dd" class="dropdown-menu"></div>
      </div>
      <label class="row muted" style="user-select:none;">
        <input id="groupToggle" type="checkbox" checked />
        Group orders
      </label>
      <div class="muted" id="status" style="margin-top:6px;"></div>
    </div>

    <div class="grid">
      <div class="panel">
        <h2 style="margin:0 0 10px;">Buy Orders (expensive → cheapest)</h2>
        <table id="buyTable">
          <thead><tr><th>Orders</th><th>Amount</th><th>Unit Price</th><th>Coin Equivalent</th></tr></thead>
          <tbody><tr><td colspan="4" class="muted">No data</td></tr></tbody>
          <tfoot><tr><td>Total:</td><td></td><td></td><td></td></tr></tfoot>
        </table>
      </div>

      <div class="panel">
        <h2 style="margin:0 0 10px;">Sell Orders (cheapest → expensive)</h2>
        <table id="sellTable">
          <thead><tr><th>Orders</th><th>Amount</th><th>Unit Price</th><th>Coin Equivalent</th></tr></thead>
          <tbody><tr><td colspan="4" class="muted">No data</td></tr></tbody>
          <tfoot><tr><td>Total:</td><td></td><td></td><td></td></tr></tfoot>
        </table>
      </div>
    </div>
  </div>

<script>
(() => {
  const API_BASE = "https://wato-api.vercel.app";

  // UI elements (make sure these exist in your HTML)
  const itemInput   = document.getElementById("itemInput");
  const groupToggle = document.getElementById("groupToggle");
  const buyBody     = document.querySelector("#buyTable tbody");
  const sellBody    = document.querySelector("#sellTable tbody");
  const buyFoot     = document.querySelector("#buyTable tfoot tr");
  const sellFoot    = document.querySelector("#sellTable tfoot tr");

  // state
  let currentItemId = "";
  let useGrouping   = false;
  let pollTimer     = null;

  const asCoins = (n) => {
    const x = Number(n) || 0;
    return x.toLocaleString(undefined, { maximumFractionDigits: 1 });
  };

  // Group rows within ±0.1% by weighted average price; round price to whole coin in grouped mode
  function groupSummary(rows) {
    if (!rows || !rows.length) return [];
    const tol = 0.001; // 0.1%

    const sorted = [...rows].sort((a,b) => a.pricePerUnit - b.pricePerUnit);
    const out = [];
    let cur = null;

    const push = () => {
      if (!cur) return;
      const avg = cur.weightedCoins / Math.max(cur.amount, 1);
      out.push({
        orders: cur.orders,
        amount: Math.round(cur.amount),
        pricePerUnit: Math.round(avg) // round to whole when grouped
      });
      cur = null;
    };

    for (const r of sorted) {
      const amount = Math.round(Number(r.amount) || 0);
      const price  = Number(r.pricePerUnit) || 0;
      const orders = Number(r.orders) || 0;
      if (!cur) {
        cur = { base: price, orders, amount, weightedCoins: price * amount };
        continue;
      }
      const rel = Math.abs(price - cur.base) / (cur.base || 1);
      if (rel <= tol) {
        cur.orders += orders;
        cur.amount += amount;
        cur.weightedCoins += price * amount;
      } else {
        push();
        cur = { base: price, orders, amount, weightedCoins: price * amount };
      }
    }
    push();
    return out;
  }

  function renderTable(rows, tbody, tfootRow) {
    tbody.innerHTML = "";
    if (!rows || !rows.length) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 4; td.className = "muted"; td.textContent = "No data";
      tr.appendChild(td); tbody.appendChild(tr);
      tfootRow.innerHTML = "<td>Total:</td><td></td><td></td><td></td>";
      return;
    }
    let totalAmt = 0, totalCoins = 0;
    for (const r of rows) {
      const amount = Math.round(Number(r.amount) || 0);
      const price  = Number(r.pricePerUnit) || 0;
      const orders = Number(r.orders) || 0;
      const coins  = amount * price;

      totalAmt += amount; totalCoins += coins;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${orders}</td>
        <td>${amount.toLocaleString()}</td>
        <td>${asCoins(price)}</td>
        <td>${asCoins(coins)}</td>
      `;
      tbody.appendChild(tr);
    }
    tfootRow.innerHTML = `
      <td>Total:</td>
      <td>${totalAmt.toLocaleString()}</td>
      <td></td>
      <td>${asCoins(totalCoins)}</td>
    `;
  }

  function sortBuySell(buyRows, sellRows) {
    // buy: expensive → cheapest
    const buySorted  = [...buyRows].sort((a,b) => b.pricePerUnit - a.pricePerUnit);
    // sell: cheapest → expensive
    const sellSorted = [...sellRows].sort((a,b) => a.pricePerUnit - b.pricePerUnit);
    return { buySorted, sellSorted };
  }

  async function fetchAndRender(itemId) {
    if (!itemId) return;
    try {
      const res = await fetch(`${API_BASE}/${encodeURIComponent(itemId)}`, { cache: "no-store" });
      if (!res.ok) throw new Error(`${res.status}`);
      const data = await res.json();

      let buy = Array.isArray(data.buy_summary)  ? data.buy_summary  : [];
      let sell = Array.isArray(data.sell_summary) ? data.sell_summary : [];

      if (useGrouping) {
        buy  = groupSummary(buy);
        sell = groupSummary(sell);
      }

      // ensure correct sort after grouping or not
      const { buySorted, sellSorted } = sortBuySell(buy, sell);

      renderTable(buySorted,  buyBody,  buyFoot);
      renderTable(sellSorted, sellBody, sellFoot);
    } catch (e) {
      // show error row
      const showErr = (tbody, tfootRow) => {
        tbody.innerHTML = "";
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 4; td.className = "muted"; td.textContent = "Error loading data";
        tr.appendChild(td); tbody.appendChild(tr);
        tfootRow.innerHTML = "<td>Total:</td><td></td><td></td><td></td>";
      };
      showErr(buyBody,  buyFoot);
      showErr(sellBody, sellFoot);
      console.error("fetch error", e);
    }
  }

  function startPolling() {
    if (pollTimer) clearInterval(pollTimer);
    if (!currentItemId) return;
    fetchAndRender(currentItemId);
    pollTimer = setInterval(() => fetchAndRender(currentItemId), 30_000);
  }

  // UI wiring
  itemInput.addEventListener("change", () => {
    currentItemId = (itemInput.value || "").trim();
    startPolling();
  });
  groupToggle.addEventListener("change", () => {
    useGrouping = !!groupToggle.checked;
    // re-render immediately with new mode
    fetchAndRender(currentItemId);
  });

  // boot with URL ?item= support if you have it
  const pre = new URLSearchParams(location.search).get("item");
  if (pre) {
    itemInput.value = pre;
    currentItemId = pre;
  }
  if (currentItemId) startPolling();
})();
</script>
</body>
</html>
