<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bazaar Orders — WATO API</title>
  <link rel="icon" type="image/png" href="site-icon.png"/>

  <style>
    :root {
      --card: rgba(0,0,0,0.65);
      --text: #f5f7fa;
      --border: rgba(255,255,255,0.12);
      --head: rgba(0,191,255,0.28);
      --ghost: rgba(186,114,255,0.18);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      color: var(--text);
      background-image: url('bgimage.jpeg');
      background-size: cover;
      background-attachment: fixed;
      background-position: center;
      font-family: system-ui, Segoe UI, Roboto, sans-serif;
    }
    .container { max-width: 1200px; margin: 36px auto; padding: 0 16px; }
    .panel {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 14px; padding: 16px; margin-bottom: 16px;
      backdrop-filter: saturate(120%) blur(2px);
    }
    label { display: block; margin-bottom: 6px; font-weight: bold; }
    input[type="text"] {
      width: 100%; padding: 12px; border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      font-size: 15px;
    }
    .dropdown {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 10px; padding: 6px; max-height: 320px;
      overflow-y: auto; display: none; margin-top: 6px;
    }
    .dropdown-item {
      padding: 8px 10px; border-radius: 8px; cursor: pointer;
    }
    .dropdown-item:hover { background: rgba(255,255,255,0.06); }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 920px) { .grid-2 { grid-template-columns: 1fr; } }

    table {
      width: 100%; border-collapse: collapse;
      border-radius: 12px; overflow: hidden;
    }
    thead th {
      background: var(--head); padding: 10px; text-align: center;
      border-bottom: 1px solid var(--border);
    }
    tbody td, tfoot td {
      padding: 10px; text-align: center;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      font-size: 14px;
    }
    tr:nth-child(even) td { background: rgba(255,255,255,0.03); }
    tfoot td { font-weight: bold; background: rgba(255,255,255,0.07); }
    .highlight-ghost { background: var(--ghost) !important; }
  </style>
</head>
<body>
  <div class="container">
    <div class="panel">
      <label>Item ID</label>
      <input id="itemInput" type="text" placeholder="Enter Item ID"/>
      <div id="itemDropdown" class="dropdown"></div>
    </div>

    <div class="grid-2">
      <div class="panel">
        <h2>Buy Orders</h2>
        <table id="buyTable">
          <thead><tr><th>Orders</th><th>Amount</th><th>Unit Price</th><th>Coin Equivalent</th></tr></thead>
          <tbody></tbody>
          <tfoot><tr><td>Total:</td><td></td><td></td><td></td></tr></tfoot>
        </table>
      </div>

      <div class="panel">
        <h2>Sell Orders</h2>
        <table id="sellTable">
          <thead><tr><th>Orders</th><th>Amount</th><th>Unit Price</th><th>Coin Equivalent</th></tr></thead>
          <tbody></tbody>
          <tfoot><tr><td>Total:</td><td></td><td></td><td></td></tr></tfoot>
        </table>
      </div>
    </div>
  </div>

  <script>
const buyBody  = document.querySelector("#buyTable tbody");
const sellBody = document.querySelector("#sellTable tbody");
const buyFoot  = document.querySelector("#buyTable tfoot tr");
const sellFoot = document.querySelector("#sellTable tfoot tr");
const itemInput  = document.getElementById("itemInput");
const itemDropdown = document.getElementById("itemDropdown");

let currentItemId = "";
let refreshTimer = null;

// The only items the API supports
const supportedItems = [
  "BOOSTER_COOKIE",
  "RECOMBOBULATOR_3000",
  "ENCHANTED_DIAMOND_BLOCK",
  "KISMET_FEATHER",
  "SUMMONING_EYE",
  "ESSENCE_CRIMSON",
  "SKELETON_KEY",
  "TITANIC_EXP_BOTTLE"
];

function populateDropdown(query){
  const filtered = supportedItems.filter(id => id.toLowerCase().includes(query.toLowerCase()));
  itemDropdown.innerHTML = "";
  for (const id of filtered) {
    const div = document.createElement("div");
    div.className = "dropdown-item";
    div.innerHTML = `<div>${id}</div>`;
    div.onclick = () => {
      itemInput.value = id;
      itemDropdown.style.display = "none";
      selectItem(id);
    };
    itemDropdown.appendChild(div);
  }
  itemDropdown.style.display = filtered.length ? "block" : "none";
}

itemInput.addEventListener("input", () => {
  const query = itemInput.value.trim();
  if (!query) { itemDropdown.style.display = "none"; return; }
  populateDropdown(query);
});

function selectItem(id){
  currentItemId = id;
  loadOrders(id);
  if (refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(() => loadOrders(currentItemId), 30000); // refresh every 30s
}

async function loadOrders(id){
  buyBody.innerHTML  = `<tr><td colspan="4" class="muted">Loading…</td></tr>`;
  sellBody.innerHTML = `<tr><td colspan="4" class="muted">Loading…</td></tr>`;
  buyFoot.innerHTML  = `<td>Total:</td><td></td><td></td><td></td>`;
  sellFoot.innerHTML = `<td>Total:</td><td></td><td></td><td></td>`;

  try {
    const res = await fetch(`https://wato-api.vercel.app/${encodeURIComponent(id)}`, { cache: 'no-store' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    // ✅ Correct sides + sorting
    const buy = (data.sell_summary  || []).slice().sort((a,b)=> b.pricePerUnit - a.pricePerUnit); // exp → cheap
    const sell = (data.buy_summary || []).slice().sort((a,b)=> a.pricePerUnit - b.pricePerUnit); // cheap → exp

    const fmt = n => Number(n ?? 0).toLocaleString();
    const coins = (amt,ppu) => Number((amt||0) * (ppu||0));

    function render(rows, tbody, tfoot){
      if (!rows.length){
        tbody.innerHTML = `<tr><td colspan="4" class="muted">No data</td></tr>`;
        tfoot.innerHTML = `<td>Total:</td><td>0</td><td></td><td>0</td>`;
        return;
      }
      let totAmt=0, totCoins=0;
      const html = rows.map(r=>{
        const amount = Math.trunc(r.amount || 0);         // whole items
        const price  = Number(r.pricePerUnit || 0);
        const ords   = Math.trunc(r.orders || 0);
        const c      = coins(amount, price);
        totAmt += amount; totCoins += c;
        return `
          <tr>
            <td>${fmt(ords)}</td>
            <td>${fmt(amount)}</td>
            <td>${fmt(price)} coins</td>
            <td>${fmt(c)} coins</td>
          </tr>`;
      }).join('');
      tbody.innerHTML = html;
      tfoot.innerHTML = `<td>Total:</td><td>${fmt(totAmt)}</td><td></td><td>${fmt(totCoins)} coins</td>`;
    }

    render(buy,  buyBody,  buyFoot);
    render(sell, sellBody, sellFoot);

  } catch (err){
    console.error(err);
    buyBody.innerHTML  = `<tr><td colspan="4" class="muted">Error loading data</td></tr>`;
    sellBody.innerHTML = `<tr><td colspan="4" class="muted">Error loading data</td></tr>`;
  }
}
</script>
</body>
</html>
