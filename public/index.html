<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bazaar Orders — Ghost Levels</title>
  <link rel="icon" type="image/jpeg" href="site-icon.png"/>
  <style>
    /* [unchanged styles from your version] */
    :root { --card: rgba(0,0,0,0.65); --text: #f5f7fa; --muted: rgba(255,255,255,0.75); --accent: #00bfff; --ghost: rgba(186,114,255,0.18); --warn1: rgba(255,255,0,0.15); --warn2: rgba(255,80,80,0.25); --hl: rgba(0,191,255,0.25); --border: rgba(255,255,255,0.12); --head: rgba(0,191,255,0.28); }
    * { box-sizing: border-box; }
    body { margin: 0; color: var(--text); background-image: url('bgimage.jpeg'); background-size: cover; background-attachment: fixed; background-position: center; font-family: system-ui, Segoe UI, Roboto, sans-serif; }
    .container { max-width: 1200px; margin: 36px auto; padding: 0 16px; }
    h1 { margin: 0 0 20px; font-weight: 700; letter-spacing: .2px; }
    .panel { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 16px; margin-bottom: 16px; backdrop-filter: saturate(120%) blur(2px); }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 920px) { .grid-2 { grid-template-columns: 1fr; } }
    label { user-select: none; cursor: pointer; display: block; margin-bottom: 6px; }
    input[type="text"]{ width: 100%; padding: 12px 12px; border-radius: 10px; border: 1px solid var(--border); background: rgba(255,255,255,0.06); color: var(--text); font-size: 15px; outline: none; }
    input[type="checkbox"] { transform: translateY(1px); }
    .row { display: flex; gap: 16px; align-items: flex-end; flex-wrap: wrap; }
    .muted { color: var(--muted); font-size: 14px; }
    table { width: 100%; border-collapse: collapse; overflow: hidden; border-radius: 12px; }
    thead th { background: var(--head); padding: 10px; text-align: center; font-weight: 700; border-bottom: 1px solid var(--border); }
    tbody td { padding: 10px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.06); font-size: 14px; }
    tfoot td { padding: 10px; font-weight: 700; background: rgba(255,255,255,0.07); }
    tr:nth-child(even) td { background: rgba(255,255,255,0.03); }
    .highlight-yellow { background: var(--warn1) !important; }
    .highlight-red    { background: var(--warn2) !important; }
    .highlight-blue   { background: var(--hl) !important; }
    .highlight-ghost  { background: var(--ghost) !important; }
    .dropdown { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 6px; max-height: 320px; overflow-y: auto; display: none; margin-top: 6px; }
    .dropdown-item { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 8px 10px; border-radius: 8px; cursor: pointer; }
    .dropdown-item:hover { background: rgba(255,255,255,0.06); }
    .pill { background: goldenrod; color: black; padding: 2px 8px; border-radius: 999px; font-weight: 700; font-size: 12px; }
    .volume { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 24px; }
    .volume strong { font-weight: 700; }
    .spread { margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.15); }
  </style>
</head>
<body>
  <div class="container">
    <!-- [UI unchanged from your paste] -->
    <h1>Bazaar Orders</h1>
    <!-- ... -->
    <div class="grid-2">
      <div class="panel"><h2>Buy Orders (expensive → cheapest)</h2><table id="buyTable"><thead><tr><th>Orders</th><th>Amount</th><th>Unit Price</th><th>Coin Equivalent</th></tr></thead><tbody></tbody><tfoot><tr><td>Total:</td><td></td><td></td><td></td></tr></tfoot></table></div>
      <div class="panel"><h2>Sell Orders (cheapest → expensive)</h2><table id="sellTable"><thead><tr><th>Orders</th><th>Amount</th><th>Unit Price</th><th>Coin Equivalent</th></tr></thead><tbody></tbody><tfoot><tr><td>Total:</td><td></td><td></td><td></td></tr></tfoot></table></div>
    </div>
  </div>
<script type="module">
  // DEBUG HELPER
  const dbg = (...args) => console.log("[GHOST DEBUG]", ...args);

  const GROUP_PCT = 0.15, POLL_MS = 3000;
  let currentItemId = "", latestBuySummary = [], latestSellSummary = [];
  let prevBuySortedDesc = [], prevSellSortedAsc = [];

  function keyPrice(p){ return Math.round(p * 10) / 10; }
  function sameLevel(a,b){ return keyPrice(a) === keyPrice(b); }
  function storageKey(id, side){ return `remembered:${id}:${side}`; }
  function readRemembered(id, side){
    const val = localStorage.getItem(storageKey(id, side)) || "[]";
    try { return JSON.parse(val); } catch { return []; }
  }
  function writeRemembered(id, side, arr){
    dbg("STORAGE WRITE", side, arr);
    localStorage.setItem(storageKey(id, side), JSON.stringify(arr));
  }
  function addGhost(id, side, price, amount, orders){
    const arr = readRemembered(id, side);
    const k = keyPrice(price);
    if (!arr.some(x => sameLevel(x.price, k))) {
      dbg("ADD GHOST", side, {price:k, amount, orders});
      arr.push({ price: k, amount: amount||0, orders: orders||1, ts: Date.now() });
      writeRemembered(id, side, arr);
    }
  }

  function rememberVanishedOutsideTop13(curBuyDesc, curSellAsc){
    dbg("Checking vanished orders for", currentItemId);
    dbg("prevBuySortedDesc:", prevBuySortedDesc.map(r=>r.pricePerUnit));
    dbg("curBuyDesc:", curBuyDesc.map(r=>r.pricePerUnit));
    dbg("prevSellSortedAsc:", prevSellSortedAsc.map(r=>r.pricePerUnit));
    dbg("curSellAsc:", curSellAsc.map(r=>r.pricePerUnit));

    const curBuyKeys = new Set(curBuyDesc.map(r=>keyPrice(r.pricePerUnit)));
    const curSellKeys = new Set(curSellAsc.map(r=>keyPrice(r.pricePerUnit)));

    prevBuySortedDesc.forEach((r, idx) => {
      if (idx >= 13) {
        const k = keyPrice(r.pricePerUnit);
        if (!curBuyKeys.has(k)) {
          dbg("Vanished BUY idx", idx, "price", k);
          addGhost(currentItemId, "buy", k, r.amount, r.orders);
        }
      }
    });
    prevSellSortedAsc.forEach((r, idx) => {
      if (idx >= 13) {
        const k = keyPrice(r.pricePerUnit);
        if (!curSellKeys.has(k)) {
          dbg("Vanished SELL idx", idx, "price", k);
          addGhost(currentItemId, "sell", k, r.amount, r.orders);
        }
      }
    });
  }

  function cleanGhostsAgainstCurrent(curBuyDesc, curSellAsc){
    const buyLevels = curBuyDesc.map(r=>keyPrice(r.pricePerUnit));
    const sellLevels = curSellAsc.map(r=>keyPrice(r.pricePerUnit));
    const bestSell = Math.min(...curBuyDesc.map(r=>r.pricePerUnit||Infinity));
    const bestBuy = Math.max(...curSellAsc.map(r=>r.pricePerUnit||-Infinity));

    function isBetween(price, levels){
      const p = keyPrice(price);
      for (let i=0;i<levels.length-1;i++){
        const lo = Math.min(levels[i], levels[i+1]);
        const hi = Math.max(levels[i], levels[i+1]);
        if (p > lo && p < hi) return true;
      }
      return false;
    }

    // BUY ghosts
    {
      const arr = readRemembered(currentItemId, "buy");
      const kept = [];
      for (const g of arr) {
        const k = keyPrice(g.price);
        if (buyLevels.includes(k)) { dbg("REMOVE buy", k, "reason: reappeared"); continue; }
        if (isBetween(k, buyLevels)) { dbg("REMOVE buy", k, "reason: between levels"); continue; }
        if (isFinite(bestBuy) && bestBuy >= k) { dbg("REMOVE buy", k, "reason: filled"); continue; }
        kept.push(g);
      }
      writeRemembered(currentItemId, "buy", kept);
    }
    // SELL ghosts
    {
      const arr = readRemembered(currentItemId, "sell");
      const kept = [];
      for (const g of arr) {
        const k = keyPrice(g.price);
        if (sellLevels.includes(k)) { dbg("REMOVE sell", k, "reason: reappeared"); continue; }
        if (isBetween(k, sellLevels)) { dbg("REMOVE sell", k, "reason: between levels"); continue; }
        if (isFinite(bestSell) && bestSell <= k) { dbg("REMOVE sell", k, "reason: filled"); continue; }
        kept.push(g);
      }
      writeRemembered(currentItemId, "sell", kept);
    }
  }

  async function loadData(itemId){
    const res = await fetch(`https://api.hypixel.net/skyblock/bazaar`);
    const json = await res.json();
    const data = json.products?.[itemId];
    if (!data) return;

    latestBuySummary = data.sell_summary ?? [];
    latestSellSummary = data.buy_summary ?? [];

    const curBuyDesc = [...latestBuySummary].sort((a,b)=>b.pricePerUnit - a.pricePerUnit);
    const curSellAsc = [...latestSellSummary].sort((a,b)=>a.pricePerUnit - b.pricePerUnit);

    if (prevBuySortedDesc.length || prevSellSortedAsc.length){
      rememberVanishedOutsideTop13(curBuyDesc, curSellAsc);
    }
    cleanGhostsAgainstCurrent(curBuyDesc, curSellAsc);

    prevBuySortedDesc = curBuyDesc;
    prevSellSortedAsc = curSellAsc;
  }

  setInterval(()=>{ if(currentItemId) loadData(currentItemId); }, POLL_MS);
  // TODO: Add UI selection handling from your original
</script>
</body>
</html>
