<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Volatile Items</title>
  <link rel="icon" type="image/jpeg" href="site-icon.png" />
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-image: url('bgimage.jpeg');
      background-size: cover;
      background-attachment: fixed;
      color: #fff;
    }
    .container {
      max-width: 1200px;
      margin: 40px auto;
      background-color: rgba(0, 0, 0, 0.75);
      padding: 30px;
      border-radius: 16px;
      position: relative;
    }
    .tabs {
      display: flex;
      gap: 10px;
      position: absolute;
      top: -40px;
      left: 20px;
    }
    .tab {
      padding: 8px 16px;
      background-color: rgba(0, 0, 0, 0.6);
      color: #fff;
      text-decoration: none;
      border-radius: 8px 8px 0 0;
    }
    .active-tab {
      background-color: rgba(255,255,255,0.1);
      border-bottom: 2px solid #00bfff;
    }
    select, input, label {
      padding: 10px;
      font-size: 16px;
      margin: 10px 10px 10px 0;
      border-radius: 6px;
      border: none;
      background-color: rgba(255,255,255,0.1);
      color: #fff;
    }
    input[type="checkbox"] {
      width: auto;
      margin-right: 5px;
    }
    button {
      padding: 10px 16px;
      font-size: 16px;
      border-radius: 6px;
      background-color: #007acc;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #005f99;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: rgba(255,255,255,0.05);
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    th {
      background-color: rgba(0, 191, 255, 0.3);
    }
    tr:hover {
      background-color: rgba(255,255,255,0.1);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="tabs">
      <a class="tab" href="index.html">Orders</a>
      <a class="tab" href="saved-orders.html">Saved Items</a>
      <a class="tab active-tab" href="volatile-items.html">Volatile Items</a>
    </div>

    <h1>Most Volatile Bazaar Items</h1>
    <p style="margin-top: -10px; color: #ccc; font-size: 16px; max-width: 800px">
      This section displays the 25 items with the highest price change based on the difference between the
      current sell order price and the historical buy instantly price. Last updated: <span id="dataAge"></span>
    </p>

    <div>
      <select id="directionSelect">
        <option value="both">Price Movement: Both</option>
        <option value="up">Price Increasing</option>
        <option value="down">Price Decreasing</option>
      </select>
      <input type="number" id="minPriceInput" placeholder="Minimum current price (coins)" />
      <label><input type="checkbox" id="excludeEnchantments" checked> Exclude ENCHANTMENT_*</label>
      <label><input type="checkbox" id="excludeUltimate" checked> Exclude ULTIMATE_*</label>
      <button onclick="loadVolatileItems()">Apply Filters</button>
    </div>

    <table id="itemsTable">
      <thead>
        <tr>
          <th>Item ID</th>
          <th>Current Sell Order</th>
          <th>Historical Buy Instantly</th>
          <th>Change (%)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    function getTimeAgo(date) {
      const now = new Date();
      const diffMs = now - date;
      const mins = Math.floor(diffMs / 60000);
      if (mins < 1) return "just now";
      if (mins < 60) return `${mins} min${mins !== 1 ? 's' : ''}`;
      const hours = Math.floor(mins / 60);
      if (hours < 24) return `${hours} hour${hours !== 1 ? 's' : ''}`;
      const days = Math.floor(hours / 24);
      return `${days} day${days !== 1 ? 's' : ''}`;
    }

    async function loadVolatileItems() {
      const direction = document.getElementById("directionSelect").value;
      const minPrice = parseFloat(document.getElementById("minPriceInput").value) || 0;
      const excludeEnchantments = document.getElementById("excludeEnchantments").checked;
      const excludeUltimate = document.getElementById("excludeUltimate").checked;

      const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT1qqH_uVwkFRtkE60-uk1-ZXnY7dUvaDwg9nBDudFcSsUuLFaF1n53Hry8D95M1daSWlE5asYB-8bL/pub?output=csv';
      const res = await fetch(csvUrl);
      const csv = await res.text();

      const rows = csv.trim().split("\n").map(r => r.split(","));
      const headers = rows[0];
      const dataRows = rows.slice(1).filter(r => r.length === headers.length);

      const oldest = dataRows[0];
      const latest = dataRows[dataRows.length - 1];
      const latestTimestamp = new Date(latest[0].trim());
      if (!isNaN(latestTimestamp)) {
        const timeAgo = getTimeAgo(latestTimestamp);
        document.getElementById("dataAge").textContent = `${timeAgo} ago (${(dataRows.length / 48).toFixed(1)} days logged)`;
      }

      const historicalMap = {};
      headers.forEach((header, i) => {
        if (/_buy$/.test(header)) {
          const itemId = header.replace(/_buy$/, "");
          const pastPrice = parseFloat(oldest[i]);
          if (isFinite(pastPrice)) {
            historicalMap[itemId] = pastPrice;
          }
        }
      });

      const apiKey = 'YOUR_HYPIXEL_API_KEY';
      const apiRes = await fetch(`https://api.hypixel.net/skyblock/bazaar?key=${apiKey}`);
      const json = await apiRes.json();
      if (!json.success) {
        alert("Failed to load Hypixel Bazaar data.");
        return;
      }

      const products = json.products || {};
      const items = [];
      for (const itemId in historicalMap) {
        if (excludeEnchantments && itemId.startsWith("ENCHANTMENT_")) continue;
        if (excludeUltimate && itemId.startsWith("ULTIMATE_")) continue;
        const past = historicalMap[itemId];
        const apiItem = products[itemId];
        if (!apiItem) continue;
        const current = apiItem.quick_status.buyPrice;
        if (!isFinite(current)) continue;
        const change = (past > 0) ? ((current - past) / past) * 100 : 0;
        items.push({ item_id: itemId, current_price: current, past_price: past, change_percent: change });
      }

      const filtered = items
        .filter(i => i.current_price >= minPrice)
        .filter(i => direction === 'both' || (direction === 'up' && i.change_percent > 0) || (direction === 'down' && i.change_percent < 0))
        .sort((a, b) => Math.abs(b.change_percent) - Math.abs(a.change_percent))
        .slice(0, 25);

      const tbody = document.querySelector("#itemsTable tbody");
      tbody.innerHTML = filtered.length === 0
        ? '<tr><td colspan="4">No items found matching the filter criteria.</td></tr>'
        : filtered.map(item => `
          <tr>
            <td>${item.item_id}</td>
            <td>${item.current_price.toLocaleString(undefined, { maximumFractionDigits: 1 })} coins</td>
            <td>${item.past_price.toLocaleString(undefined, { maximumFractionDigits: 1 })} coins</td>
            <td style="color: ${item.change_percent > 0 ? '#00ff99' : '#ff6666'}">
              ${item.change_percent.toFixed(1)}%
            </td>
          </tr>
        `).join("");
    }
  </script>
</body>
</html>
